<!DOCTYPE html>
<html lang="en">

<head>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
    <title></title>

    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <link rel="stylesheet" href="../lib/globalStyle2.css" />

    <style type="text/css">

      body {
        max-width:700px;
        margin: 0 auto;
      }

		  .axis path {stroke:none !important;}

      .group-0 .bar-0 {
        fill: #091E30;
        stroke: #091E30;
        stroke-width:1px;
      }

      .group-0 .bar-1 {
        fill: #206095;
        stroke: #206095;
        stroke-width:1px;
      }

      .group-1 .bar-0 {
        fill: #5E4B25;
        stroke: #5E4B25;
        stroke-width:1px;
      }

      .group-1 .bar-1 {
        fill: #fff;
        stroke: #B8860B;
        stroke-width:1px;
        stroke-dasharray: 4 4;
      }

      .group-2 .bar-0 {
        fill: #001118;
        stroke: #001118;
        stroke-width:1px;
      }

      .group-2 .bar-1 {
        fill: #004463;
        stroke: #004463;
        stroke-width:1px;
      }

      .group-3 .bar-0 {
        fill: #054443;
        stroke: #054443;
        stroke-width:1px;
      }

      .group-3 .bar-1 {
        fill: #008080;
        stroke: #008080;
        stroke-width:1px;

      }

      .group-4 .bar-0 {
        fill: #135066;
        stroke: #135066;
        stroke-width:1px;
      }

      .group-4 .bar-1 {
        fill: #27A0CC;
        stroke: #27A0CC;
        stroke-width:1px;
      }

      .groups .bar-0 {
        fill: #CCD0D1;
        stroke: #CCD0D1;
        stroke-width:1px;
      }

      .groups .bar-1 {
        fill: #E3E5E6;
        stroke: #E3E5E6;
        stroke-width:1px;
      }

      .group-1 .bar-1 {
        fill: #fff;
      }

      .circles-0 {
        fill: #206095;
        stroke: #206095;
      }


      .circles-1 {
        fill: #B8860B;
        stroke: #B8860B;
      }

      .circles-2 {
        fill: #004463;
        stroke: #004463;
      }

      .circles-3 {
        fill: #008080;
        stroke: #008080;
      }

      .circles-4 {
        fill: #27A0CC;
        stroke: #27A0CC;
      }

      .circles {
        stroke-width: 2px;
      }


      .circlesfade {
        fill: #fff;
        stroke: #D0D2D3;
      }

      .textcircle {
        font-family: "Open Sans";
        font-weight:600;
        font-size: 14px;
        fill: #fff;
      }

      .textcirclefade {
        fill: #323132;
        font-weight:400;
      }

      .breaklines {
        stroke:#323132;
        stroke-width:2px;
        stroke-dasharray: 4;

      }

      .navline {
        stroke:#d0d2d3;
        stroke-width:2px;

      }

      .headertext {
        font-family: "Open Sans";
        font-size:20px;
        font-weight:bold;
        color: #323132;
        margin-bottom:10px;
        margin-top:15px;
      }

      .detailtext, .introtext {
        font-family: "Open Sans";
        font-size: 16px;
        font-weight: 400;
        line-height: 24px;
        margin-bottom:10px;
      }


      .btn--primary-alternative {
          background-color: #206095;
          color: #fff;
      }
      .btn--bold {
          font-weight: 600;
      }
      .btn {
          font-family: "Open Sans",Helvetica,Arial,sans-serif;
          font-weight: 600;
          font-size: 14px;
          display: inline-block;
          width: auto;
          cursor: pointer;
          padding: 6px 16px 10px 16px;
          border: 0 none;
          text-align: center;
          -webkit-appearance: none;
          transition: background-color 0.25s ease-out;
          text-decoration: none;
          line-height: 24px;
      }
      button {
          cursor: pointer;
      }
      #start {
        float: right;
      }

      #back {
        float: left;
        display:none;

      }

      #next {
        float: right;
        display:none;
      }

      .key {
        width: 70%;
        float: left;
      }

      .source {
        font-weight:400;
      }

      .sectiontitle {
        font-family:"Open Sans";
        font-size:24px;
        color: #323132;
        font-weight:700;
        margin-bottom: 10px;
      }

      .controls {
        margin-top:10px;
      }

		  /* .bar-0 { fill: #E73f40; }
      .bar-1 { fill: #7bcae2; }
      .bar-2 { fill: #f3942f; }
  		.bar-3 { fill: #274796; }
  		.bar-4 { fill: #979796; } */

      .key-0 b {margin-top:0px !important; width: 15px !important; background-color: #CCD0D1; }
      .key-1 b {margin-top:0px !important; width: 15px !important; background-color: #E3E5E6; }
      .key-2 b {margin-top:0px !important; width: 15px !important; background-color: #f3942f; }
      .key-3 b {margin-top:0px !important; width: 15px !important; background-color: #274796; }
      .key-4 b {margin-top:0px !important; width: 15px !important; background-color: #979796; }

      .footer2 {
        display:none;
      }

      @media (max-width:791px) {

        .sectiontitle{
            font-size:24px;
            font-weight:600;
        }

        .footer {
          display:none;
        }

        .footer2 {
          display:block;
          font-size:14px;
        }

        .key {
          width:100%;

        }

        #graphic .key label {
          font-size: 16px;
        }

        #graphic .axis {
          font-family: 'Open Sans', sans-serif;
          font-size: 14px;
        }

        .headertext {
          font-size: 16px;
          font-weight: bold;
        }

        .detailtext, .introtext {
            font-family: "Open Sans";
            font-size: 14px;
            font-weight: 400;
            line-height: 20px;
            margin-bottom: 10px;
        }


      }

    </style>

</head>
<body>

	<div id="graphic">
    	<img src="fallback.png" alt="[Chart]" />
    </div>

    <div class="source2">
    </div>

   <div class="details">
     <h3 class="headertext">Title</h3>
     <p class="detailtext">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus in lorem ac sapien cursus tincidunt. Vivamus fermentum dolor eu dui malesuada tincidunt. Fusce nisl ex, cursus in elit nec, condimentum varius dui. In eget eleifend ipsum. Cras convallis libero efficitur purus consectetur sollicitudin. Donec molestie accumsan porttitor. Morbi ultrices purus ac ex egestas sollicitudin.
     </p>

   </div>
   <div class="controls">
     <button id="start" class="btn btn--primary-alternative btn--bold btn--large">
           Start
      </button>
     <button id="back" class="btn btn--primary-alternative btn--bold btn--large">
           &#9664; Back
      </button>

      <button id="next" class="btn btn--primary-alternative btn--bold btn--large">
           Next &#9658;
       </button>
   </div>

    <script src="https://cdn.ons.gov.uk/vendor/d3/4.2.7/d3.min.js" type="text/javascript"></script>
    <script src="../lib/modernizr.svg.min.js" type="text/javascript"></script>
    <script src="../lib/pym.js" type="text/javascript"></script>
    <script>

	var graphic = d3.select('#graphic');
	var keypoints = d3.select('#keypoints');
	var footer = d3.select(".footer");

  var counter = 0;

	var pymChild = null;



function drawGraphic(width) {
	threshold_md = 788;
	threshold_sm = dvc.optional.mobileBreakpoint;


	if (parseInt(graphic.style("width")) < threshold_sm) {
			var margin = {top: dvc.optional.margin_sm[0], right: dvc.optional.margin_sm[1], bottom: dvc.optional.margin_sm[2], left: dvc.optional.margin_sm[3]};
			var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
			height = Math.ceil((chart_width * dvc.optional.aspectRatio_sm[1]) / dvc.optional.aspectRatio_sm[0]) - margin.top - margin.bottom;
	} else if (parseInt(graphic.style("width")) < threshold_md){
			var margin = {top: dvc.optional.margin_md[0], right: dvc.optional.margin_md[1], bottom: dvc.optional.margin_md[2], left: dvc.optional.margin_md[3]};
			var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
			height = Math.ceil((chart_width * dvc.optional.aspectRatio_md[1]) / dvc.optional.aspectRatio_md[0]) - margin.top - margin.bottom;
	} else {
			var margin = {top: dvc.optional.margin_lg[0], right: dvc.optional.margin_lg[1], bottom: dvc.optional.margin_lg[2], left: dvc.optional.margin_lg[3]}
			var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
			height = Math.ceil((chart_width * dvc.optional.aspectRatio_lg[1]) / dvc.optional.aspectRatio_lg[0]) - margin.top - margin.bottom;
	}

	// clear out existing graphics
	graphic.selectAll("*").remove();
	keypoints.selectAll("*").remove();
	footer.selectAll("*").remove();


	y = d3.scaleBand()
		.rangeRound([0, height])
    .padding(0.4);

	x = d3.scaleLinear()
		.range([0,chart_width]);



  var formatAsPercentage = d3.formatPrefix('%',0);

  //y.domain(d3.extent(graphic_data, function(d) { return d.cat; }));

  var yAxis = d3.axisLeft(y)
      .tickFormat(function(d,i) { return d; })
	    .tickPadding(5);


	d3.selectAll(".tick").selectAll("line").attr("transform", "translate(30,0)");

  xAxis = d3.axisBottom(x);

	if (parseInt(graphic.style("width")) <= threshold_sm) {
			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[0])
		 } else if (parseInt(graphic.style("width")) <= threshold_md){
			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[1])
		 } else {
			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[2])
		 }


  var x_axis_grid = function() { return xAxis; }

  d3.select('#graphic')
      .append("h3")
      .attr("class","sectiontitle")
      .text(dvc.detailstext.sectiontitle[counter]);

  d3.select('#graphic')
      .append("h3")
      .attr("class","introtext")
      .text("Understanding the flow of the criminal justice system is important in order to.....Cras id magna iaculis, condimentum libero vitae, egestas nisl. Pellentesque euismod, mi eget viverra tincidunt, ligula nunc dapibus ex, nec maximus justo urna id magna. Phasellus eros sapien, lacinia eu pulvinar at, dignissim vel neque. Nulla tincidunt mollis urna, at consectetur odio suscipit ac. Donec feugiat sem id molestie condimentum. M");

	var legend = d3.select('#graphic')
          .append('ul')
					.attr('class', 'key')
					.selectAll('g')
					.data(dvc.essential.legendLabels)
					.enter().append('li')
					.attr("class",function(d,i){return "key-" + i})

  var source = d3.select('#graphic').append("div")
                  .attr("class","footer")
                  .html("Source: <br>")
                  .append("a")
                  .attr("class","source")
                  .attr("href", dvc.sources.urls[0])
                  .attr("target", "_blank")
                  .text(dvc.sources.description[0]);

  var source2 = d3.select('.source2').append("div")
                  .attr("class","footer2")
                  .html("Source: ")
                  .append("a")
                  .attr("class","source3")
                  .attr("href", dvc.sources.urls[0])
                  .attr("target", "_blank")
                  .text(dvc.sources.description[0]);


	legend.append('b')
	legend.append('label')
		.html(function(d,i) { return dvc.essential.legendLabels[i]; });

  var svg = d3.select('#graphic').append('svg')
      .attr("width", chart_width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	y.domain(graphic_data.map(function(d) {
		return d.cat;
	}));

	//y domain calculations	: zero to intelligent max choice, or intelligent min and max choice,  or interval chosen manually
	if (dvc.essential.xAxisScale == "auto_zero_max"){
	   var xDomain = [
						0,Math.ceil(d3.max(dvc.rows))
					 ];
	} else if (dvc.essential.xAxisScale == "auto_min_max"){
		console.log("not appropriate for a stack bar chart");
	} else {
	   var xDomain = dvc.essential.xAxisScale;
	}

	x.domain(xDomain);


    svg.append('g')
        .attr('class', 'y axis')
        .attr('transform', 'translate(0,' + (height*1.00) + ')')
        .call(xAxis);

    svg.append('g')
        .attr('class', 'x axis')
        .call(yAxis)
        .style("text-anchor", "start")
        .attr("transform","translate(" + (-margin.left+11+45) + ",0)")
	 .append("text")
		 .attr("y", height+23)
		 .attr("x",chart_width)
		 .attr("dy", ".71em")
		 .style("text-anchor", "start")
		 .text(dvc.essential.xAxisLabel);

    svg.append('g')
        .attr('class', 'x grid')
        .call(x_axis_grid()
            .tickSize(height, 0)
            .tickFormat('')
        );


    var group = svg.selectAll(".year")
      .data(graphic_data)
	    .enter().append("g")
      .attr("class",function(d,i){return "g bars group-" + i})
      .attr("transform", function(d) { return "translate(0," + y(d.cat) + ")"; });

	  group.selectAll("rect")
      .data(function(d) { return d.vars; })
      .enter().append("rect")
	    .attr("class",function(d,i){return "indbars bar-" + i})
      .attr("height", y.bandwidth())
	    .attr("x", function(d) {
	  //console.log("0 " + d.x1);
			if (d.x1 >=0){
				return x(d.x0);
			} else {
				return x(d.x2)+ (x(d.x0) - x(d.x1));
			}
			})
	  .attr("width", function(d) {
	  			//console.log("0 " + d.x0);
			if (d.x1 >=0){
				return Math.abs(x(d.x0) - x(d.x1));
			} else {
				return Math.abs(x(d.x0) - x(d.x1));

			}
	  })
	  .style("opacity", 1);


    svg.append("line")
      .attr("class","breaklines breaklines1")
      .attr("x1",x(0))
      .attr("x2",x(800000))
      .attr("y1",((y("Estimated  victims") + y.bandwidth()) + y("Reported  to police")) / 2)
      .attr("y2",((y("Estimated  victims") + y.bandwidth()) + y("Reported  to police")) / 2)



      svg.append("line")
        .attr("class","breaklines breaklines2")
        .attr("x1",x(0))
        .attr("x2",x(800000))
        .attr("y1",((y("Recorded  by police") + y.bandwidth()) + y("Suspects  charged")) / 2)
        .attr("y2",((y("Recorded  by police") + y.bandwidth()) + y("Suspects  charged")) / 2)


    svg.append("line")
      .attr("class","navline")
      .attr("x1",x(0) - margin.left + 15)
      .attr("x2",x(0) - margin.left + 15)
      .attr("y1",y("Estimated  victims") + y.bandwidth()/2)
      .attr("y2",y("Offenders  convicted") + y.bandwidth()/2)

      svg.append("g")
        .attr("class","progress")
        .selectAll("circle")
        .data(graphic_data)
        .enter()
        .append("circle")
        .attr("class", function(d,i) {return "circles circles-" + i})
        .attr("cx", x(0) - margin.left + 15)
        .attr("cy", function(d,i) {return y(d.cat) + y.bandwidth()/2})
        .attr("r", 13)

    svg.select(".progress")
      .selectAll("text")
      .data(graphic_data)
      .enter()
      .append("text")
      .attr("class", function(d,i) {return "textcircle textcircle-" + i})
      .attr("x", x(0) - margin.left + 15)
      .attr("y", function(d,i) {return y(d.cat) + y.bandwidth()/2 + 5})
      .attr("text-anchor", "middle")
      .text(function(d,i){return i+1});




	  writeAnnotation();

		function writeAnnotation(){


			if (parseInt(graphic.style("width")) < threshold_sm) {

					dvc.essential.annotationBullet.forEach(function(d,i) {

						d3.select("#keypoints").append("svg")
							.attr("width","20px")
							.attr("height","20px")
							.attr("class","circles")
							.append("circle")
							.attr("class", "annocirc" + (i))
							.attr("r", "2")
							.attr('cy',"12px")
							.attr("cx", "10px");

						d3.select("#keypoints").append("p").text(dvc.essential.annotationBullet[i]);

					})// end foreach

			}
			else {

					dvc.essential.annotationChart.forEach(function(d,i) {

						// draw annotation text based on content of var annotationArray ...
						svg.append("text")
							.text(dvc.essential.annotationChart[i])
							.attr("class","annotext" + i)
							.attr("text-anchor", dvc.essential.annotationAlign[i])
							.attr('x',x(dvc.essential.annotationXY[i][0]))
							.attr('y', y(dvc.essential.annotationXY[i][1]));

						d3.selectAll(".annotext" + (i))
							.each(insertLinebreaks)
							.each(createBackRect);

            //hack for first annotation
            d3.select(".annotext0").attr("transform","translate(0," + eval(y.bandwidth()-8) + ")")


						function insertLinebreaks() {

							var str = this;

							var el1 = dvc.essential.annotationChart[i];

							var words = el1.split('  ');

							d3.select(this/*str*/).text('');

							for (var j = 0; j < words.length; j++) {
								var tspan = d3.select(this).append('tspan').text(words[j]);
								if (j > 0)
									tspan.attr('x', x(dvc.essential.annotationXY[i][1]))
										.attr('dy', '22');
									}
						};

						function createBackRect() {

						var BBox = this.getBBox()

								svg.insert("rect", ".annotext" + (i))
									.attr("width", BBox.width +6)
									.attr("height", BBox.height+6)
									.attr("x", BBox.x -3)
									.attr("y", BBox.y -3)
									.attr("fill", "white")
									.attr("opacity", 0.4);

						}; // end function createBackRect()


						// draw circles, if var 'dvc.essential.circles' is set to true
						if ( dvc.essential.circles == true ) {

							svg.append("circle")
								.attr("class", "annocirc" + (i))
								.attr('cx',x(dvc.essential.annotationCXCY[i][0]))
								.attr('cy', y(dvc.essential.annotationCXCY[i][1]))
								.attr("r", "3");

						} // end if ...

					});	// end foreach

			} // end else ...


			// If you have labels rather than years then you can split the lines using a double space (in the CSV file).



			d3.selectAll(".x text").attr("y",-9).each(insertLinebreaksLabels)


		}// end function writeAnnotation()



    if (chart_width > dvc.optional.mobileBreakpoint) {
	} else {

	}

  d3.select("#start").on("click",changeCounterNext);
  d3.select("#back").on("click",changeCounterBack);
  d3.select("#next").on("click",changeCounterNext);

  //changeDetails();


    if (pymChild) {
        pymChild.sendHeight();
    }
}

function changeCounterBack(){
  if(counter !=0) {
    counter = counter - 1;
  }

  changeDetails(counter);
}

function changeCounterNext(){
  if(counter <=6) {
    counter = counter + 1;
  }

  changeDetails(counter);
}

function changeDetails(counter) {

  if(counter > 0) {
    d3.select("#start").style("display","none");
    d3.select("#next").style("display","block");
    d3.select("#back").style("display","block");
    d3.select(".introtext").style("display","none");

  }

  if(counter == 6){
    d3.select("#next").style("display","none");
  }

  d3.select(".sectiontitle").text(dvc.detailstext.sectiontitle[counter]);
  d3.select(".headertext").text(dvc.detailstext.headertitles[counter]);
  d3.select(".source").attr("href", dvc.sources.urls[counter]).text(dvc.sources.description[counter]);
  d3.select(".source3").attr("href", dvc.sources.urls[counter]).text(dvc.sources.description[counter]);
  d3.select(".detailtext").text(dvc.detailstext.details[counter]);

  d3.selectAll(".bars").classed("groups",true);
  d3.selectAll(".group-" + (counter-1)).classed("groups", false);

  d3.selectAll(".circles").classed("circlesfade",true);
  d3.selectAll(".circles-" + (counter-1)).classed("circlesfade", false);


  d3.selectAll(".textcircle").classed("textcirclefade",true);
  d3.selectAll(".textcircle-" + (counter-1)).classed("textcirclefade", false);


  if(counter == 0) {
    d3.select("#start").style("display","block");
    d3.select("#next").style("display","none");
    d3.select("#back").style("display","none");
    d3.select(".introtext").style("display","block");

    d3.selectAll(".bars").classed("groups",false);
    d3.selectAll(".textcircle").classed("textcirclefade",false);
    d3.selectAll(".circles").classed("circlesfade",false);

    d3.selectAll(".annotext0, .annotext1, .annotext2")
      .transition()
      .duration(500)
      .style("opacity",1);
  }

  if(counter == 1) {

    y.domain(graphic_data.map(function(d) {
      return d.cat;
    }));


    d3.selectAll(".annotext0, .annotext1, .annotext2")
      .transition()
      .duration(500)
      .style("opacity",0);

      d3.select(".navline")
          .attr("y1",y("Estimated  victims") + y.bandwidth()/2)
          .attr("y2",y("Offenders  convicted") + y.bandwidth()/2)

  }

  if(counter == 2) {

      y.domain(graphic_data.map(function(d) {
        return d.cat;
      }));

      x.domain([0,800000]);

      var yAxis = d3.axisLeft(y)
          .tickFormat(function(d,i) { return d; })
          .tickPadding(5);

      d3.select(".x")
      .call(yAxis);

      xAxis = d3.axisBottom(x);

      if (parseInt(graphic.style("width")) <= threshold_sm) {
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[0])
         } else if (parseInt(graphic.style("width")) <= threshold_md){
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[1])
         } else {
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[2])
         }


      var x_axis_grid = function() { return xAxis; }

      d3.select(".y")
      .transition()
      .duration(500)
      .call(xAxis);

      d3.select(".grid")
        .call(x_axis_grid()
            .tickSize(height, 0)
            .tickFormat('')
        );

      d3.selectAll(".x text").attr("y",-9).each(insertLinebreaksLabels)

      d3.selectAll(".bars")
        .transition()
        .duration(500)
        .attr("transform", function(d) { return "translate(0," + y(d.cat) + ")"; });


      d3.selectAll(".indbars")
        .transition()
        .duration(500)
        .attr("height", y.bandwidth())
        .attr("x", function(d) {
        if (d.x1 >=0){
          return x(d.x0);
        } else {
          return x(d.x2)+ (x(d.x0) - x(d.x1));
        }
        })
      .attr("width", function(d) {
            //console.log("0 " + d.x0);
        if (d.x1 >=0){
          return Math.abs(x(d.x0) - x(d.x1));
        } else {
          return Math.abs(x(d.x0) - x(d.x1));

        }
      })

      d3.selectAll(".circles")
        .transition()
        .duration(500)
        .attr("cy", function(d,i) {return y(d.cat) + y.bandwidth()/2})

      d3.selectAll(".textcircle")
        .transition()
        .duration(500)
        .attr("y", function(d,i) {return y(d.cat) + y.bandwidth()/2 + 5})

      d3.select(".navline")
          .attr("y1",y("Estimated  victims") + y.bandwidth()/2)
          .attr("y2",y("Offenders  convicted") + y.bandwidth()/2)

      d3.select(".breaklines2")
        .transition()
        .duration(500)
        .attr("y1",((y("Recorded  by police") + y.bandwidth()) + y("Suspects  charged")) / 2)
        .attr("y2",((y("Recorded  by police") + y.bandwidth()) + y("Suspects  charged")) / 2)

      d3.select(".circles-0")
        .attr("cy", function(d,i) {return y(d.cat) + y.bandwidth()/2})
        .transition()
        .delay(501)
        .duration(200)
        .style("opacity",1);

      d3.select(".textcircle-0")
        .attr("y", function(d,i) {return y(d.cat) + y.bandwidth()/2 + 5})
        .transition()
        .delay(501)
        .duration(200)
        .style("opacity",1);

      d3.select(".group-0")
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);

      d3.select(".breaklines1")
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);


  }

  if(counter == 3) {

      xxx = graphic_data.filter(function(d) { return d.cat !== "Estimated  victims";});

      y.domain(xxx.map(function(d) {
        return d.cat;
      }));

      x.domain([0,250000]);

      var yAxis = d3.axisLeft(y)
          .tickFormat(function(d,i) { return d; })
          .tickPadding(5);

      d3.select(".x")
        .call(yAxis);

      xAxis = d3.axisBottom(x);

    	if (parseInt(graphic.style("width")) <= threshold_sm) {
    			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[0])
    		 } else if (parseInt(graphic.style("width")) <= threshold_md){
    			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[1])
    		 } else {
    			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[2])
    		 }


      var x_axis_grid = function() { return xAxis; }

      d3.select(".y")
      .transition()
      .duration(500)
      .call(xAxis);

      d3.select(".grid")
        .call(x_axis_grid()
            .tickSize(height, 0)
            .tickFormat('')
        );

      d3.selectAll(".x text").attr("y",-9).each(insertLinebreaksLabels)

      d3.selectAll(".bars")
        .transition()
        .duration(500)
        .attr("transform", function(d) { return "translate(0," + y(d.cat) + ")"; });


      d3.selectAll(".indbars")
        .transition()
        .duration(500)
        .attr("height", y.bandwidth())
  	    .attr("x", function(d) {
  			if (d.x1 >=0){
  				return x(d.x0);
  			} else {
  				return x(d.x2)+ (x(d.x0) - x(d.x1));
  			}
  			})
  	  .attr("width", function(d) {
  	  			//console.log("0 " + d.x0);
  			if (d.x1 >=0){
  				return Math.abs(x(d.x0) - x(d.x1));
  			} else {
  				return Math.abs(x(d.x0) - x(d.x1));

  			}
  	  })

      d3.select(".navline")
          .attr("y1",y("Estimated  victims") + y.bandwidth()/2)
          .attr("y2",y("Offenders  convicted") + y.bandwidth()/2)

      d3.selectAll(".circles")
        .transition()
        .duration(500)
        .attr("cy",  function(d,i) {console.log(d.cat); return y(d.cat) + y.bandwidth()/2})

      d3.selectAll(".textcircle")
        .transition()
        .duration(500)
        .attr("y", function(d,i) {return y(d.cat) + y.bandwidth()/2 + 5})


      d3.select(".breaklines2")
        .transition()
        .duration(500)
        .attr("y1",((y("Recorded  by police") + y.bandwidth()) + y("Suspects  charged")) / 2)
        .attr("y2",((y("Recorded  by police") + y.bandwidth()) + y("Suspects  charged")) / 2)

      d3.selectAll(".circles-0")
        .transition()
        .duration(200)
        .style("opacity",0);

      d3.selectAll(".textcircle-0")
        .transition()
        .duration(200)
        .style("opacity",0);

      d3.selectAll(".group-0")
        .transition()
        .duration(200)
        .style("opacity",0);

      d3.selectAll(".breaklines1")
        .transition()
        .duration(200)
        .style("opacity",0);

      d3.selectAll(".circles-1, .circles-2")
        .attr("cy", function(d,i) {return y(d.cat) + y.bandwidth()/2})
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);

      d3.selectAll(".textcircle-1, .textcircle-2")
        .attr("y", function(d,i) {return y(d.cat) + y.bandwidth()/2 + 5})
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);

      d3.selectAll(".group-1, .group-2")
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);

      d3.select(".breaklines2")
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);


  }

  if(counter == 4 || counter==5) {

      xxx = graphic_data.filter(function(d) { return d.cat !== "Estimated  victims" && d.cat !== "Reported  to police" && d.cat!=="Recorded  by police"});

      y.domain(xxx.map(function(d) {
        return d.cat;
      }));

      x.domain([0,40000]);

      var yAxis = d3.axisLeft(y)
          .tickFormat(function(d,i) { return d; })
          .tickPadding(5);

      d3.select(".x")
        .call(yAxis);

      xAxis = d3.axisBottom(x);

      if (parseInt(graphic.style("width")) <= threshold_sm) {
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[0])
         } else if (parseInt(graphic.style("width")) <= threshold_md){
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[1])
         } else {
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[2])
         }


      var x_axis_grid = function() { return xAxis; }

      d3.select(".y")
      .transition()
      .duration(500)
      .call(xAxis);

      d3.select(".grid")
        .call(x_axis_grid()
            .tickSize(height, 0)
            .tickFormat('')
        );

      d3.selectAll(".y .tick").attr("transform","translate(-1)").each(insertLinebreaksLabels)

      d3.selectAll(".x text").attr("y",-9).each(insertLinebreaksLabels)

      d3.selectAll(".bars")
        .transition()
        .duration(500)
        .attr("transform", function(d) { return "translate(0," + y(d.cat) + ")"; });

      d3.select(".navline")
          .attr("y1",y("Recorded  by police") + y.bandwidth()/2)
          .attr("y2",y("Offenders  convicted") + y.bandwidth()/2)

      d3.selectAll(".indbars")
        .transition()
        .duration(500)
        .attr("height", y.bandwidth())
        .attr("x", function(d) {
        if (d.x1 >=0){
          return x(d.x0);
        } else {
          return x(d.x2)+ (x(d.x0) - x(d.x1));
        }
        })
      .attr("width", function(d) {
            //console.log("0 " + d.x0);
        if (d.x1 >=0){
          return Math.abs(x(d.x0) - x(d.x1));
        } else {
          return Math.abs(x(d.x0) - x(d.x1));

        }
      })


      d3.select(".navline")
        .attr("y1",y("Estimated  victims") + y.bandwidth()/2)
        .attr("y2",y("Offenders  convicted") + y.bandwidth()/2)

      d3.selectAll(".circles")
        .transition()
        .duration(500)
        .attr("cy",  function(d,i) {console.log(d.cat); return y(d.cat) + y.bandwidth()/2})

      d3.selectAll(".textcircle")
        .transition()
        .duration(500)
        .attr("y", function(d,i) {return y(d.cat) + y.bandwidth()/2 + 5})


      d3.selectAll(".circles-0, .circles-1, .circles-2")
        .transition()
        .duration(200)
        .style("opacity",0);

      d3.selectAll(".textcircle-0, .textcircle-1, .textcircle-2")
        .transition()
        .duration(200)
        .style("opacity",0);

      d3.selectAll(".group-0, .group-1, .group-2")
        .transition()
        .duration(200)
        .style("opacity",0);

      d3.selectAll(".breaklines1, .breaklines2")
        .transition()
        .duration(200)
        .style("opacity",0);


      d3.selectAll(".annotext0, .annotext1, .annotext2")
      .transition()
      .duration(500)
      .style("opacity",0);



  }

  if(counter == 6) {

      y.domain(graphic_data.map(function(d) {
        return d.cat;
      }));

      x.domain([0,800000]);

      var yAxis = d3.axisLeft(y)
          .tickFormat(function(d,i) { return d; })
          .tickPadding(5);

      d3.select(".x")
        .call(yAxis);

      xAxis = d3.axisBottom(x);

      if (parseInt(graphic.style("width")) <= threshold_sm) {
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[0])
         } else if (parseInt(graphic.style("width")) <= threshold_md){
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[1])
         } else {
          xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[2])
         }


      var x_axis_grid = function() { return xAxis; }

      d3.select(".y")
      .transition()
      .duration(500)
      .call(xAxis);

      d3.select(".grid")
        .call(x_axis_grid()
            .tickSize(height, 0)
            .tickFormat('')
        );

      d3.selectAll(".x text").attr("y",-9).each(insertLinebreaksLabels)

      d3.selectAll(".bars")
        .transition()
        .duration(500)
        .attr("transform", function(d) { return "translate(0," + y(d.cat) + ")"; });


      d3.select(".navline")
          .attr("y1",y("Estimated  victims") + y.bandwidth()/2)
          .attr("y2",y("Offenders  convicted") + y.bandwidth()/2)

      d3.selectAll(".indbars")
        .transition()
        .duration(500)
        .attr("height", y.bandwidth())
        .attr("x", function(d) {
        if (d.x1 >=0){
          return x(d.x0);
        } else {
          return x(d.x2)+ (x(d.x0) - x(d.x1));
        }
        })
      .attr("width", function(d) {
            //console.log("0 " + d.x0);
        if (d.x1 >=0){
          return Math.abs(x(d.x0) - x(d.x1));
        } else {
          return Math.abs(x(d.x0) - x(d.x1));

        }
      })

      d3.select(".breaklines2")
        .transition()
        .duration(500)
        .attr("y1",((y("Recorded  by police") + y.bandwidth()) + y("Suspects  charged")) / 2)
        .attr("y2",((y("Recorded  by police") + y.bandwidth()) + y("Suspects  charged")) / 2)


      d3.selectAll(".circles")
        .attr("cy", function(d,i) {return y(d.cat) + y.bandwidth()/2})
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);

      d3.selectAll(".textcircle")
        .attr("y", function(d,i) {return y(d.cat) + y.bandwidth()/2 + 5})
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);

      d3.selectAll(".groups")
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);

      d3.selectAll(".breaklines1, .breaklines2")
        .transition()
        .delay(500)
        .duration(200)
        .style("opacity",1);

      d3.selectAll(".bars").classed("groups",false);
      d3.selectAll(".circles").classed("circlesfade",false);
      d3.selectAll(".textcircle").classed("textcirclefade",false);

      d3.selectAll(".annotext0, .annotext1, .annotext2")
        .transition()
        .delay(500)
        .style("opacity",1);

  }



}

function insertLinebreaksLabels() {
        var str = this.textContent;

        var words = str.split('  ');

        d3.select(this/*str*/).text('');

        for (var j = 0; j < words.length; j++) {
          var tspan = d3.select(this).append('tspan').text(words[j]);
          if (j > 0)
            tspan
            .attr('x', -10)
            .attr('dy', '1.1em');
            }
};



	if (Modernizr.svg) {

		d3.json("config.json", function(error, config) {
		dvc=config



			d3.csv(dvc.essential.graphic_data_url, function(error, data) {
				graphic_data = data;
				varnames = d3.keys(graphic_data[0]).filter(function(key) { return key !== "group";});

				graphic_data.forEach(function(d) {

					d.cat = d.group;

					var x0 = 0;
					d.vars = varnames.map(function(name){ return {
								name: name,
								x0: x0,
								x1: x0 += +d[name],
								x2: d[name]
							};
					 });

					d.total = d.vars[d.vars.length - 1].y1;
				});

				// Cycle through data and sum all data for all data columns
				d3.csv(dvc.essential.graphic_data_url).row(function(d) {
							  var mySum = 0;
							  for (var o in d) { // iterate all the properties of d
								  if (o === "group") continue; // if it's our key field skip it
								  else mySum += +d[o]; // everyone else into the sum
								}
								return mySum

						   })
						 .get(function(error, rows) {
							dvc.rows=rows;
							pymChild = new pym.Child({ renderCallback: drawGraphic});
						  });

			});



	});

	} else {
		 pymChild = new pym.Child();
		if (pymChild) {
			pymChild.sendHeight();
		}
	}


    </script>
</body>
</html>
